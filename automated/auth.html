<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login & Signup - Metadata Removal Tool</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:system-ui,Segoe UI,Roboto;
    background:#0f172a;
    color:#e2e8f0;
    padding:20px;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
}

.container{max-width:450px;width:100%}

.header{text-align:center;margin-bottom:40px}
.header h1{
    font-size:2.5rem;
    background:linear-gradient(135deg,#667eea,#764ba2);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    margin-bottom:10px;
}
.header p{color:#94a3b8;font-size:1.1rem}

.card{
    background:#1e293b;
    padding:40px;
    border-radius:20px;
    border:1px solid #334155;
    box-shadow:0 20px 60px rgba(0,0,0,.5);
}

.tabs{
    display:flex;
    gap:10px;
    margin-bottom:30px;
}

.tab{
    flex:1;
    padding:12px;
    text-align:center;
    background:#0f172a;
    border:2px solid #334155;
    border-radius:10px;
    cursor:pointer;
    transition:.3s;
    font-weight:600;
}

.tab.active{
    background:linear-gradient(135deg,#667eea,#764ba2);
    border-color:transparent;
    color:#fff;
}

.form-group{margin-bottom:20px}

.form-group label{
    display:block;
    margin-bottom:8px;
    color:#94a3b8;
    font-size:.9rem;
    font-weight:500;
}

.form-group input{
    width:100%;
    padding:14px;
    border-radius:10px;
    font-size:1rem;
    background:#0f172a;
    color:#e2e8f0;
    border:2px solid #334155;
    transition:.3s;
}

.form-group input:focus{
    outline:none;
    border-color:#667eea;
}

.form-group input::placeholder{color:#475569}

button{
    width:100%;
    padding:16px;
    border-radius:10px;
    font-size:1.05rem;
    border:none;
    cursor:pointer;
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:#fff;
    font-weight:600;
    transition:.3s;
    margin-top:10px;
}

button:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 25px rgba(102,126,234,.3);
}

button:disabled{
    opacity:.5;
    cursor:not-allowed;
    transform:none;
}

.error{
    background:rgba(239,68,68,.2);
    border:2px solid #ef4444;
    padding:12px;
    border-radius:10px;
    margin-bottom:20px;
    color:#ef4444;
    font-size:.95rem;
}

.success{
    background:rgba(34,197,94,.2);
    border:2px solid #22c55e;
    padding:12px;
    border-radius:10px;
    margin-bottom:20px;
    color:#22c55e;
    font-size:.95rem;
}

.hidden{display:none}

.link-text{
    text-align:center;
    margin-top:20px;
    color:#94a3b8;
    font-size:.95rem;
}

.link-text a{
    color:#667eea;
    text-decoration:none;
    font-weight:600;
}

.link-text a:hover{text-decoration:underline}

.password-strength{
    margin-top:8px;
    font-size:.85rem;
}

.strength-bar{
    height:4px;
    background:#334155;
    border-radius:2px;
    margin-top:5px;
    overflow:hidden;
}

.strength-fill{
    height:100%;
    width:0;
    transition:.3s;
    border-radius:2px;
}

.strength-weak{background:#ef4444;width:33%}
.strength-medium{background:#f59e0b;width:66%}
.strength-strong{background:#22c55e;width:100%}

.loading-spinner{
    display:inline-block;
    width:16px;
    height:16px;
    border:2px solid #fff;
    border-top:2px solid transparent;
    border-radius:50%;
    animation:spin .6s linear infinite;
}

@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>üõ°Ô∏è Welcome</h1>
        <p>Secure your files with metadata removal</p>
    </div>

    <div class="card">
        <div class="tabs">
            <div class="tab active" id="loginTab">Login</div>
            <div class="tab" id="signupTab">Sign Up</div>
        </div>

        <div id="message"></div>

        <!-- Login Form -->
        <form id="loginForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" required>
            </div>
            <button type="submit" id="loginBtn">
                üîì Login
            </button>
        </form>

        <!-- Signup Form -->
        <form id="signupForm" class="hidden">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="signupUsername" placeholder="Choose username" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signupEmail" placeholder="your@email.com" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signupPassword" placeholder="Create strong password" required>
                <div class="password-strength hidden" id="strengthIndicator">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <span id="strengthText"></span>
                </div>
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="signupPassword2" placeholder="Re-enter password" required>
            </div>
            <div class="form-group">
                <label>First Name (Optional)</label>
                <input type="text" id="signupFirstName" placeholder="First name">
            </div>
            <div class="form-group">
                <label>Last Name (Optional)</label>
                <input type="text" id="signupLastName" placeholder="Last name">
            </div>
            <button type="submit" id="signupBtn">
                ‚ú® Create Account
            </button>
        </form>

        <div class="link-text">
            <a href="index.html">‚Üê Back to Home</a>
        </div>
    </div>
</div>

<script>
const API = "http://127.0.0.1:8000/api";

// Tab switching
const loginTab = document.getElementById("loginTab");
const signupTab = document.getElementById("signupTab");
const loginForm = document.getElementById("loginForm");
const signupForm = document.getElementById("signupForm");
const messageDiv = document.getElementById("message");

loginTab.onclick = () => {
    loginTab.classList.add("active");
    signupTab.classList.remove("active");
    loginForm.classList.remove("hidden");
    signupForm.classList.add("hidden");
    clearMessage();
};

signupTab.onclick = () => {
    signupTab.classList.add("active");
    loginTab.classList.remove("active");
    signupForm.classList.remove("hidden");
    loginForm.classList.add("hidden");
    clearMessage();
};

// Password strength checker
const signupPassword = document.getElementById("signupPassword");
const strengthIndicator = document.getElementById("strengthIndicator");
const strengthFill = document.getElementById("strengthFill");
const strengthText = document.getElementById("strengthText");

signupPassword.oninput = (e) => {
    const password = e.target.value;
    if (password.length === 0) {
        strengthIndicator.classList.add("hidden");
        return;
    }
    
    strengthIndicator.classList.remove("hidden");
    
    let strength = 0;
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;
    
    strengthFill.className = "strength-fill";
    if (strength <= 1) {
        strengthFill.classList.add("strength-weak");
        strengthText.textContent = "Weak password";
        strengthText.style.color = "#ef4444";
    } else if (strength <= 2) {
        strengthFill.classList.add("strength-medium");
        strengthText.textContent = "Medium strength";
        strengthText.style.color = "#f59e0b";
    } else {
        strengthFill.classList.add("strength-strong");
        strengthText.textContent = "Strong password";
        strengthText.style.color = "#22c55e";
    }
};

// Message functions
function showError(msg) {
    messageDiv.innerHTML = `<div class="error">‚ùå ${msg}</div>`;
}

function showSuccess(msg) {
    messageDiv.innerHTML = `<div class="success">‚úÖ ${msg}</div>`;
}

function clearMessage() {
    messageDiv.innerHTML = "";
}

// Login handler
loginForm.onsubmit = async (e) => {
    e.preventDefault();
    clearMessage();
    
    const btn = document.getElementById("loginBtn");
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> Logging in...';
    
    const username = document.getElementById("loginUsername").value;
    const password = document.getElementById("loginPassword").value;
    
    try {
        const response = await fetch(`${API}/auth/login/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.non_field_errors?.[0] || data.detail || "Login failed");
        }
        
        // Store token and user info
        localStorage.setItem("token", data.token);
        localStorage.setItem("user", JSON.stringify(data.user));
        
        showSuccess("Login successful! Redirecting...");
        
        setTimeout(() => {
            window.location.href = "index.html";
        }, 1000);
        
    } catch (error) {
        // Display field-specific errors or general error
        if (error.message.includes('username')) {
            showError('Username already exists. Please choose a different username.');
        } else if (error.message.includes('email')) {
            showError('Email already registered. Please use a different email or login.');
        } else {
            showError(error.message);
        }
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
};

// Signup handler
signupForm.onsubmit = async (e) => {
    e.preventDefault();
    clearMessage();
    
    const btn = document.getElementById("signupBtn");
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> Creating account...';
    
    const username = document.getElementById("signupUsername").value;
    const email = document.getElementById("signupEmail").value;
    const password = document.getElementById("signupPassword").value;
    const password2 = document.getElementById("signupPassword2").value;
    const firstName = document.getElementById("signupFirstName").value;
    const lastName = document.getElementById("signupLastName").value;
    
    if (password !== password2) {
        showError("Passwords do not match!");
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
    }
    
    try {
        const response = await fetch(`${API}/auth/register/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username,
                email,
                password,
                password2,
                first_name: firstName,
                last_name: lastName
            })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            // Handle field-specific errors from Django
            if (data.username) {
                throw new Error(`Username: ${data.username[0]}`);
            }
            if (data.email) {
                throw new Error(`Email: ${data.email[0]}`);
            }
            if (data.password) {
                throw new Error(`Password: ${data.password[0]}`);
            }
            
            // Handle general errors
            const errors = [];
            for (const [key, value] of Object.entries(data)) {
                if (Array.isArray(value)) {
                    errors.push(...value);
                } else {
                    errors.push(value);
                }
            }
            throw new Error(errors.join(", "));
        }
        
        // Store token and user info
        localStorage.setItem("token", data.token);
        localStorage.setItem("user", JSON.stringify(data.user));
        
        showSuccess("Account created successfully! Redirecting...");
        
        setTimeout(() => {
            window.location.href = "index.html";
        }, 1500);
        
    } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
};

// Check if already logged in
if (localStorage.getItem("token")) {
    window.location.href = "index.html";
}
</script>
</body>
</html>